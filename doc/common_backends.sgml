<chapter id='common_backends'>
<title>Common backends</title>

<sect1 id='backend_plaintext'>
<title>Plaintext</title>

<para>
Users/Groups definitions are stored in a plaintext file (though passwords
are encoded using unix <varname>crypt</varname> function).
</para>

<para>
You can edit the file <quote>users</quote>, either being offline or
reloading backend (without commiting it !) after. You should pay attention
to the fact that this file should be edited <emphasis>carefully</emphasis>,
and will be overwritten next time backend is commited.
</para>

<para>
The default logging channel for the plaintext backend is <emphasis>21</emphasis>.
</para>
</sect1>



<sect1 id='backend_pam'>
<title>PAM</title>

<para>
This is a very simple module, which uses PAM (Pluggable Authentication Modules)
to authenticate users.
</para>
<para>
User's rootpath is set to the real user's homedir, and all ips are automatically
allowed for all users. The root user is automatically promoted to siteop.
</para>
<para>
To use this backend, you <emphasis>must</emphasis> run the server as root (no
other than root is allowed to authenticate with pam).
</para>
<para>
<emphasis>Work in progress !</emphasis>
</para>
</sect1>



<sect1 id='backend_mysql'>
<title>Mysql</title>

<para>
Users/Groups definitions are stored in a mysql database.
</para>
<para>
Here are some instructions how to use MySQL as a backend for users/groups.
</para>

<simplesect>
<title>Installation</title>
<para>
<itemizedlist>
<listitem><para>Reinstall wzdftpd if you don't already have MySQL support. The MySQL support is
automatically installed if you don't use --disable-mysql.</para>
<para>If MySQL: YES doesn't show up at the end of your ./configure, either you don't have MySQL installed or
libmysql is not detected (if you installed it in a non-standard place, you need additional flags to
./configure.
</para></listitem>
<listitem><para>In the source dir there is a dir called backends/mysql/ where all files regarding the MySQL
backend. Pay attention to the two files with the extention .sql, these are instruction files for MySQL on
how to create/delete a user, database and tables that wzdftpd will use.
</para></listitem>
<listitem><para>
Let's look at tables.sql which is the file that creates all user/database/tables. If you don't have any
experience with MySQL before you should look at <ulink
url="http://www.mysql.com">http://www.mysql.com</ulink> and learn or google some up, but the SQL language
is quite understandable. Im gonna go through the lines, what they do and what you "need" to change.
<programlisting>CREATE DATABASE IF NOT EXISTS wzdftpd;</programlisting>
This creates a database with the name wzdftpd.
<programlisting>GRANT ALL ON `wzdftpd`.* TO "wzdftpd"@"localhost" IDENTIFIED BY "wzdftpd";</programlisting>
This allows your user wzdftpd to connect from localhost with the password wzdftpd, and grants all privileges
on the wzdftpd database and all the tables in it to the user wzdftpd if he connect from localhost.
</para>
<para>
Save the file and write down or remember the database, user and password that you edited in the file.
</para>
<para>
<emphasis>IMPORTANT</emphasis>: Remember to chmod your tables.sql so only YOU can read them, otherwise
everyone can read your password and add/edit/remove users/privileges/settings on wzdftpd !
</para></listitem>
<listitem><para>
Now we're gonna insert that data into MySQL. First you must have your root password or an user which is
allowed to create databases and grant usage to other users. I assume you will use root and is in the dir
where tables.sql is.
<programlisting>shell&gt; mysql -u root -p &lt; tables.sql</programlisting>
Just enter your root password for MySQL and everything should be working. If you have forgotten your root
password, look at this url: <ulink
url="http://dev.mysql.com/doc/mysql/en/resetting-permissions.html">http://dev.mysql.com/doc/mysql/en/resetting-permissions.html</ulink>
</para></listitem>
<listitem><para>
Now we're gonna edit your wzd.cfg file, if you don't have one just copy it from the wzd.cfg.sample and edit
it. The interesting line in the file is these two:
<programlisting>#backend = /path/to/wzdftpd/share/wzdftpd/backends/libwzdmysql.so
#backend_param_mysql = login:password@host:base</programlisting>
Uncomment those lines and add the user, password, and database that you edited in tables.sql.
</para>
<para>
With the default configuration, not recommended, it should look like this:
<programlisting>backend = /path/to/wzdftpd/share/wzdftpd/backends/libwzdmysql.so
backend_param_mysql = wzdftpd:wzdftpd@localhost:wzdftpd</programlisting>
</para></listitem>
<listitem><para>
Start wzdftpd and use as normal.
</para></listitem>
</itemizedlist>
</para>
</simplesect>

<simplesect>
<title>Uninstall</title>
<para>
<itemizedlist>
<listitem><para>
Use the backends/mysql/dropall.sql in the source dir:
<programlisting>shell&gt; mysql -u root -p &lt; dropall.sql</programlisting>
</para></listitem>
<listitem><para>
Comment/delete the references to mysql in wzd.cfg
</para></listitem>
</itemizedlist>
</para>
</simplesect>


</sect1>


<sect1 id='backend_pgsql'>
<title>PostgreSQL</title>

<para>
This backend is very similar to the MySQL one, except that it uses PostgreSQL
(and thus add constraints to ensure tables integrity). The PostgreSQL backend
can (and should) be preferred to MySQL when possible, as the design is better
done and uses the real possibilities of a database, like sequences, constraints,
etc.
</para>
<para>
You should first create the wzdftpd user.
<programlisting>
# su postgres
$ psql -f createusers.sql template1
</programlisting>
You must allow the user wzdftpd to connect using a password:
edit file <screen>/etc/postgresql/pg_hba.conf</screen> and add
<programlisting>
host   wzdftpd     wzdftpd      127.0.0.1         255.255.255.255   md5
</programlisting>
Restart the server.
</para>
<para>
Create the initial table structure using the following:
<programlisting>
$ psql -Uwzdftpd -f tables.sql wzdftpd
Password:
</programlisting>
Default password is "wzdftpd" (you should change it in file createusers.sql !).
</para>
<para>
To use the PostgreSQL backend, add the following to you config file:
<programlisting>backend = /path/to/wzdftpd/share/wzdftpd/backends/libwzdpgsql.so
backend_param_pgsql = login:password@host:base[:port]</programlisting>
</para>
<para>
The port is optional and will be defaulted to 5432.
</para>

<para>
The default logging channel for the postgresql backend is <emphasis>27</emphasis>.
</para>

<para>
<emphasis>Add comments on schema, constraints, etc.</emphasis>
<emphasis>Work in progress !</emphasis>
</para>
</sect1>


</chapter>
